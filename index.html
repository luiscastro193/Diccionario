<!doctype html>
<html lang="es">
	<head>
		<meta charset="utf-8">
		<title>Diccionario inglés-español</title>
		<meta name="author" content="Luis Castro Martín">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="icon" href="favicon.ico">
		<script src="https://unpkg.com/xregexp/xregexp-all.js"></script>
		<script src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>
	</head>

	<body>
		<p>Diccionario inglés-español</p>
		<input type="file" onchange="readText(this)" onclick="this.value = null" style="width: 100%" autofocus>
		<p id="errorMsg"></p>
		<br>
		<form autocomplete="off" autocorrect="off" onsubmit="enviar(this); return false">
			<input type="text" id="formCadena" accesskey='s' onmouseenter="this.focus()"
				onfocus="this.value = ''" oninput="buscarPalabra(this.value.toLowerCase())" disabled >
		</form>
		<ul id="enlaces"></ul>
		<script>
			"use strict";
			var diccionario;
			var errorMsg = document.getElementById("errorMsg");
			var formCadena = document.getElementById("formCadena");
			var ulist = document.getElementById("enlaces");
			var inputTrusted, submitTrusted;
			
			function readText(filePath) {
				formCadena.disabled = true;
				errorMsg.innerHTML = "Cargando...";
				diccionario = new Set();
				
				var reader = new FileReader();
				
				reader.onerror = function(event) {
					errorMsg.innerHTML = "Error al cargar el archivo.";
				};
				
				var fileName = filePath.files[0].name;
				
				if (fileName.substr(fileName.lastIndexOf('.')+1).toLowerCase() == "pdf") {
					reader.onload = function(event) {
						PDFJS.getDocument(new Uint8Array(event.target.result)).then(function(pdf) {
							var maxPages = pdf.pdfInfo.numPages;
							var countPromises = [];
						
							for (var i = 1; i <= maxPages; i++) {
								countPromises.push(pdf.getPage(i).then(function(page){
									return page.getTextContent().then(function(text){
										let lastY, str = '';
								
										for (let item of text.items) {
											if (lastY == item.transform[5] || !lastY)
												str += item.str;
											else
												str += '\n' + item.str;
												
											lastY = item.transform[5];
										}
									
										return str;
									});
								}));
							}
						
							Promise.all(countPromises).then(function(texts) {
								aniadirPalabras(texts.join('\n'));
								formCadena.disabled = false;
								formCadena.focus();
								errorMsg.innerHTML = '';
							});
						}, function(reason){
							errorMsg.innerHTML = reason.message;
						});
					};
				
					reader.readAsArrayBuffer(filePath.files[0]);
				}
				else{
					reader.onload = function(event) {
						aniadirPalabras(event.target.result);
						formCadena.disabled = false;
						formCadena.focus();
						errorMsg.innerHTML = '';
					}
					
					reader.readAsText(filePath.files[0]);
				}
			}
			
			function aniadirPalabras(texto){
				var expresion = XRegExp("\\pL+(?:-[\r\n]*\\pL+)*", 'g');
				var palabra;
				while (palabra = expresion.exec(texto))
					diccionario.add(String(palabra).replace(/-[\r\n]+/g, '').toLowerCase());
			}
			
			window.addEventListener('focus', function() {
				formCadena.focus();
			});
			
			function abrirEnlace(){
				if (ulist.lastChild) ulist.lastChild.firstChild.click();
			}
			
			function enviar(form) {
				if (submitTrusted)
					abrirEnlace();

				else if (submitTrusted === undefined && ulist.lastChild) {
					if (window.open(ulist.lastChild.firstChild.href, "_blank")) {
						submitTrusted = true;
						ulist.lastChild.firstChild.onclick();
					}
					else {
						submitTrusted = false;
						form.onkeyup = function(event) {
							if (event.keyCode == 13) abrirEnlace();
						};
					}
				}
			}
			
			function buscarPalabra(cadena) {
				ulist.innerHTML = '';
				
				for (let palabra of diccionario) {
					if (palabra.includes(cadena)) {
						var a = document.createElement("a");
						var newItem = document.createElement("li");
						
						a.textContent = palabra;
						a.setAttribute('href', "http://www.wordreference.com/es/translation.asp?tranword=" + palabra);
						a.setAttribute('target', "_blank");
						a.setAttribute('onclick', "aniadirLinksExtra(this.parentElement, this.textContent)");
						newItem.appendChild(a);
						ulist.appendChild(newItem);
						
						if (ulist.childElementCount >= 20) break;
					}
				}
				
				if (ulist.childElementCount == 1 && ulist.lastChild.childElementCount <= 1) {
					if (inputTrusted)
						abrirEnlace();

					else if (inputTrusted === undefined) {
						if (window.open(ulist.lastChild.firstChild.href, "_blank")) {
							inputTrusted = true;
							ulist.lastChild.firstChild.onclick();
						}
						else {
							inputTrusted = false;
							formCadena.onkeyup = function() {
								if (ulist.childElementCount == 1 && ulist.lastChild.childElementCount <= 1) abrirEnlace();
							};
						}
					}
				}
			}
			
			function aniadirLinksExtra(item, palabra) {
				if (item.childElementCount <= 1) {
					var a1 = document.createElement("a");
					var a2 = document.createElement("a");
					var a3 = document.createElement("a");
					var a4 = document.createElement("a");
					
					a1.textContent = "en Cambridge";
					a2.textContent = "en Collins";
					a3.textContent = "en Wiktionary";
					a4.textContent = "en Google";
					
					a1.setAttribute('href', "https://dictionary.cambridge.org/es/buscar/english/direct/?q=" + palabra);
					a2.setAttribute('href', "https://www.collinsdictionary.com/es/buscar/?dictCode=english&q=" + palabra);
					a3.setAttribute('href', "https://en.wiktionary.org/w/index.php?search=" + palabra);
					a4.setAttribute('href', "https://www.google.es/search?q=" + palabra);
					
					a1.setAttribute('target', "_blank");
					a2.setAttribute('target', "_blank");
					a3.setAttribute('target', "_blank");
					a4.setAttribute('target', "_blank");
					
					item.insertAdjacentHTML('beforeend', "&nbsp&nbsp&nbsp");
					item.appendChild(a1);
					item.insertAdjacentHTML('beforeend', "&nbsp&nbsp&nbsp");
					item.appendChild(a2);
					item.insertAdjacentHTML('beforeend', "&nbsp&nbsp&nbsp");
					item.appendChild(a3);
					item.insertAdjacentHTML('beforeend', "&nbsp&nbsp&nbsp");
					item.appendChild(a4);
				}
			}
		</script>
	</body>
</html>
