<!doctype html>
<html lang="es">
	<head>
		<meta charset="utf-8">
		<title>Diccionario inglés-español</title>
		<meta name="author" content="Luis Castro Martín">
		<script>
			(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
			ga('create', 'UA-93469643-1', 'auto');
			ga('send', 'pageview');
		</script>
		<script src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>
	</head>

	<body>
		<p id="description">Diccionario inglés-español</p>
		<input type="file" id="fileInput" onchange='readText(this)' />
		<p id="errorMsg"></p>
		<br>
		<form autocomplete="off" onsubmit="return abrirEnlace()">
			<input type="text" id="formCadena" accesskey='s' onmouseenter="this.focus()"
				onfocus="this.value = ''" oninput='buscarPalabra(this.value.toLowerCase())' disabled >
		</form>
		<ul id="enlaces"></ul>
		<script>
			var diccionario;
			var errorMsg = document.getElementById("errorMsg");
			var formCadena = document.getElementById("formCadena");
			var ulist = document.getElementById("enlaces");
			
			function readText(filePath) {
				formCadena.disabled = true;
				errorMsg.innerHTML = "Cargando...";
				diccionario = new Set();
				
				var reader = new FileReader();
				
				reader.onerror = function(event) {
					errorMsg.innerHTML = "Error al cargar el archivo.";
				};
				
				var fileName = filePath.files[0].name;
				
				if (fileName.substr(fileName.lastIndexOf('.')+1).toLowerCase() == "pdf") {
					reader.onload = function(event) {
						PDFJS.disableWorker = true;
						
						PDFJS.getDocument(new Uint8Array(event.target.result)).then(function(pdf) {
							var maxPages = pdf.pdfInfo.numPages;
							var countPromises = [];
						
							for (var i = 1; i <= maxPages; i++) {
								countPromises.push(pdf.getPage(i).then(function(page){
									page.getTextContent().then(function(text){
										text.items.map(function (s) { aniadirPalabras(s.str); });
									});
								}));
							}
						
							Promise.all(countPromises).then(function() {
								formCadena.disabled = false;
								errorMsg.innerHTML = '';
							});
						}, function(reason){
							errorMsg.innerHTML = reason.message;
						});
					};
				
					reader.readAsArrayBuffer(filePath.files[0]);
				}
				else{
					reader.onload = function(event) {
						aniadirPalabras(event.target.result);
						formCadena.disabled = false;
						errorMsg.innerHTML = '';
					}
					
					reader.readAsText(filePath.files[0]);
				}
			}
			
			function aniadirPalabras(texto){
				var expresion = /[^\W\d_]+-?[^\W\d_]+/g;
				var palabra;
				while (palabra = expresion.exec(texto)) diccionario.add(String(palabra).toLowerCase());
			}
			
			window.addEventListener('focus', function() {
				formCadena.focus();
			});
		
			function abrirEnlace(){
				if (ulist.childElementCount == 1) ulist.firstChild.firstChild.click();
				return false;
			}
		
			function buscarPalabra(cadena) {
				"use strict";
				ulist.innerHTML = '';
				
				for (let palabra of diccionario) {
					if (palabra.includes(cadena)) {
						var a = document.createElement("a");
						var newItem = document.createElement("li");
						
						a.textContent = palabra;
						a.setAttribute('href', "http://www.wordreference.com/enes/" + palabra);
						a.setAttribute('target', "_blank");
						a.setAttribute('onclick', 'aniadirLinksExtra(this.parentElement, this.textContent)');
						newItem.appendChild(a);
						ulist.appendChild(newItem);
						
						if (ulist.childElementCount >= 10) break;
					}
				}
			}
			
			function aniadirLinksExtra(item, palabra) {
				if (item.childElementCount <= 1) {
					var a1 = document.createElement("a");
					var a2 = document.createElement("a");
					var a3 = document.createElement("a");
				
					a1.textContent = "Oxford";
					a2.textContent = "UrbanDictionary";
					a3.textContent = "Google";
				
					a1.setAttribute('href', "https://en.oxforddictionaries.com/search?filter=noad&query=" + palabra);
					a2.setAttribute('href', "http://www.urbandictionary.com/define.php?term=" + palabra);
					a3.setAttribute('href', "https://www.google.es/search?q=" + palabra);
				
					a1.setAttribute('target', "_blank");
					a2.setAttribute('target', "_blank");
					a3.setAttribute('target', "_blank");
					
					item.insertAdjacentHTML('beforeend', "&nbsp&nbsp&nbsp");
					item.appendChild(a1);
					item.insertAdjacentHTML('beforeend', "&nbsp&nbsp&nbsp");
					item.appendChild(a2);
					item.insertAdjacentHTML('beforeend', "&nbsp&nbsp&nbsp");
					item.appendChild(a3);
				}
			}
		</script>
	</body>
</html>
